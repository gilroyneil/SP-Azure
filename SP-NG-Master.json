{
    "$schema": "http://schema.management.azure.com/schemas/2014-04-01-preview/deploymentTemplate.json",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "ServiceName": {
            "type": "string"
        },
        "resourceLocation": {
            "type": "string"
        },
            
        "NumberSPServers" : {
            "type":"int"
        },
            "NumberSQLServers" : {
            "type":"int"
        },
        "administratorAccount": {
            "type": "string"
        },
        "administratorPassword": {
            "type": "string"
        },
        "servicePassword": {
            "type": "string"
        },
        "domainJoinUserName": {
            "type": "string"
        },
        "domainJoinPassword": {
            "type": "string"
        },
        "domainJoinOU": {
            "type": "string"
        },
        "domainName": {
            "type": "string"
        },
        "domainNetBiosName": {
            "type": "string"
        },
        
        
        "MediaContainerName": {
            "type": "string"
        },
        
        "StorageAccountName": {
            "type": "string"
        },
        
        "StorageAccountKey": {
            "type": "string"
        },
        
       
        
        
        "VMSizeSP": {
            "type": "string"
        },
        "VMSizeSQL": {
            "type": "string"
        },
        "virtualNetworkName": {
            "type": "string"
        },
        "virtualNetworkResourceGroup": {
            "type": "string"
        },
        "subnetSPName": {
            "type": "string"
        },        
        "subnetSQLName": {
            "type": "string"
        }
    },
    "variables":{
        "virtualNetworkResourceGroup":"[parameters('virtualNetworkResourceGroup')]",
        "virtualNetworkName":"[parameters('virtualNetworkName')]",
        "subnetSPName":"[parameters('subnetSPName')]",
        "subnetSQLName":"[parameters('subnetSQLName')]",
        "resourceLocation":"[parameters('resourceLocation')]",
          
        "MediaContainerName":"[parameters('MediaContainerName')]",
        "StorageAccountName":"[parameters('StorageAccountName')]",
        "StorageAccountKey":"[parameters('StorageAccountKey')]",
        
        "templatelink_SQLServers":"https://raw.githubusercontent.com/gilroyneil/SP-Azure/master/SP-NG-SQLServers.json", 
        "templatelink_SPServers":"https://raw.githubusercontent.com/gilroyneil/SP-Azure/master/SP-NG-SPServers.json", 
        "templatelink_Network":"https://raw.githubusercontent.com/gilroyneil/SP-Azure/master/SP-NG-Network.json", 
        "templatelink_Scripts_Common":"https://raw.githubusercontent.com/gilroyneil/SP-Azure/master/SP-NG-Scripts-Common.json", 
        "DCDomainName":"[concat(parameters('ServiceName'),'-DC')]",    
        "SPDomainName":"[concat(parameters('ServiceName'),'-SP')]",
        "SQLDomainName":"[concat(parameters('ServiceName'),'-SQL')]",
        "StorageType":"Standard_LRS",
        "DCHardware":"Basic_A0",
        "SPHardware":"[parameters('vmSizeSP')]",
        "SQLHardware":"[parameters('vmSizeSQL')]",        
        "StorageName":"[concat(parameters('ServiceName'),'storage')]",    
        "VNetName":"[concat(parameters('ServiceName'),'VNet')]",    
        "DC1Name":"[concat(parameters('ServiceName'),'-dc1')]", 
        "SP1Name":"[concat(parameters('ServiceName'),'-sp1')]", 
        "SQL1Name":"[concat(parameters('ServiceName'),'-sql1')]", 
        "DC1Disk1Name":"[concat(parameters('ServiceName'),'-DC1-os')]",
        "DC1Disk2Name":"[concat(parameters('ServiceName'),'-DC1-data')]",
        "SP1Disk1Name":"[concat(parameters('ServiceName'),'-SP1-os')]",
        "SP1Disk2Name":"[concat(parameters('ServiceName'),'-SP1-data1')]",
        "SP1Disk3Name":"[concat(parameters('ServiceName'),'-SP1-data2')]",
        "SQL1Disk1Name":"[concat(parameters('ServiceName'),'-SQL1-os')]",
        "SQL1Disk2Name":"[concat(parameters('ServiceName'),'-SQL1-data1')]",
        "SQL1Disk3Name":"[concat(parameters('ServiceName'),'-SQL1-data2')]",
        
        "SPPrepareMachineModules":"\"xComputerManagement\",\"xNetworking\",\"xActiveDirectory\"",
        "SQLPrepareMachineModules":"\"xComputerManagement\",\"xNetworking\",\"xActiveDirectory\",\"xSQLServer_1.2.1.0\"",
        "DCPrepareMachineModules":"\"xComputerManagement\",\"xActiveDirectory\"",
        "DCImage": "a699494373c04fc0bc8f2bb1389d6106__Windows-Server-2012-R2-201502.01-en.us-127GB.vhd",
        "SPImage": "03f55de797f546a1b29d1b8d66be687a__Visual-Studio-2013-Ultimate-Update4-AzureSDK-2.5-WS2012-201502.23",
        "SQLImage": "03f55de797f546a1b29d1b8d66be687a__Visual-Studio-2013-Ultimate-Update4-AzureSDK-2.5-WS2012-201502.23",        
        "CreateSPCommand" : "[concat('powershell.exe -ExecutionPolicy Unrestricted -Command .\\CreateSPServer.ps1 -DomainName \"',parameters('domainName'),'\" -domainNetBiosName \"',parameters('domainNetBiosName'),'\" -DomainAdministratorUserName \"',parameters('administratorAccount'),'\" -DomainAdministratorPassword \"',parameters('administratorPassword'), '\" -ServiceUserName \"SQLService\" -ServicePassword \"',parameters('servicePassword'), '\"')]",
        "SetupSQLCommand" : "[concat('powershell.exe -ExecutionPolicy Unrestricted -Command .\\SetupSQL.ps1 -DomainNetBiosName \"',parameters('domainNetBiosName'),'\" -SQLServiceAccount \"SQLService\" -SQLServiceAccountPassword \"',parameters('servicePassword'), '\" -SQLAgentAccount \"SQLAgent\" -SQLAgentAccountPassword \"',parameters('servicePassword'), '\" -SQLDrive  \"F\"  -SetupAccount \"SPSetup\"')]",
        "SetupSPCommand" : "[concat('powershell.exe -ExecutionPolicy Unrestricted -Command .\\SetupSP.ps1 -DomainName \"',parameters('domainName'),'\" -domainNetBiosName \"',parameters('domainNetBiosName'),'\" -DomainAdministratorUserName \"',parameters('administratorAccount'),'\" -DomainAdministratorPassword \"',parameters('administratorPassword'), '\" -ServiceUserName \"SQLService\" -ServicePassword \"',parameters('servicePassword'), '\"')]"
            
    },
    "resources": [
        
  
         {
            "type": "Microsoft.ClassicStorage/StorageAccounts",
            "name": "[variables('StorageName')]",
            "apiVersion": "2014-06-01",
            "location": "[parameters('resourceLocation')]",
            "properties": {
                "accountType": "[variables('StorageType')]"
            }
        },
        
        /*
        {
            "type": "Microsoft.ClassicNetwork/virtualNetworks",
            "name": "[variables('VNetName')]",
            "apiVersion": "2014-06-01",
            "location": "[parameters('resourceLocation')]",
            "properties": {
                "addressSpace": {
                    "addressPrefixes": [
                        "10.1.0.0/26"
                    ]
                },
                "dhcpOptions": {
                    "dnsServers": [ "10.1.0.20" ]
                },
                "subnets": [
                    {
                        "name": "Subnet-SP",
                        "addressPrefix": "10.1.0.0/28"
                    },
                    {
                        "name": "Subnet-DC",
                        "addressPrefix": "10.1.0.16/28"
                    }
                ]
            }
        },
        */
        /*
        { 
             "apiVersion": "2015-01-01", 
             "name": "SQL-Servers-Template", 
             "type": "Microsoft.Resources/deployments",             
             "properties": { 
               "mode": "incremental", 
               "templateLink": {"uri":"[variables('templatelink_SQLServers')]","contentVersion":"1.0.0.0"}, 
               "parameters": 
               { 
                  "ServiceName":{"value":"[parameters('ServiceName')]"},
                  "resourceLocation":{"value":"[parameters('resourceLocation')]"},
                  "administratorAccount":{"value":"[parameters('administratorAccount')]"},
                  "administratorPassword":{"value":"[parameters('administratorPassword')]"},
                  "servicePassword":{"value":"[parameters('servicePassword')]"},
                  "domainJoinUserName":{"value":"[parameters('domainJoinUserName')]"},
                  "domainJoinPassword":{"value":"[parameters('domainJoinPassword')]"},
                  "domainJoinOU":{"value":"[parameters('domainJoinOU')]"},
                  
                  "domainName":{"value":"[parameters('domainName')]"},
                  "domainNetBiosName":{"value":"[parameters('domainNetBiosName')]"},
                  "VMSizeSQL":{"value":"[parameters('VMSizeSQL')]"},
                   "virtualNetworkResourceGroup":{"value":"[parameters('virtualNetworkResourceGroup')]"},
                  "virtualNetworkName":{"value":"[parameters('virtualNetworkName')]"},                  
                  "subnetSQLName":{"value":"[parameters('subnetSQLName')]"},
                  "numberSQLServers":{"value":"[parameters('NumberSQLServers')]"}
                  }            
                  
                   
               },
            "dependsOn": [               
               
                "[concat('Microsoft.ClassicStorage/storageAccounts/', variables('StorageName'))]"
            ] 
              
          }, 
          
          
          */
          /*
          
            { 
             "apiVersion": "2015-01-01", 
             "name": "Network-Template", 
             "type": "Microsoft.Resources/deployments", 
             "properties": { 
               "mode": "incremental", 
               "templateLink": {"uri":"[variables('templatelink_Network')]","contentVersion":"1.0.0.0"}, 
               "parameters": 
               { 
                  "ServiceName":{"value":"[parameters('ServiceName')]"},
                  "resourceLocation":{"value":"[parameters('resourceLocation')]"},
                  "virtualNetworkResourceGroup":{"value":"[parameters('virtualNetworkResourceGroup')]"},
                  "virtualNetworkName":{"value":"[parameters('virtualNetworkName')]"},
                  "subnetSPName":{"value":"[parameters('subnetSPName')]"},
                  "subnetSQLName":{"value":"[parameters('subnetSQLName')]"}
                  }            
                  
                   
               },
            "dependsOn": [                              
                "[concat('Microsoft.ClassicStorage/storageAccounts/', variables('StorageName'))]"
            ] 
              
          }, 
          
          
        { 
             "apiVersion": "2015-01-01", 
             "name": "SP-Servers-Template", 
             "type": "Microsoft.Resources/deployments", 
             "properties": { 
               "mode": "incremental", 
               "templateLink": {"uri":"[variables('templatelink_SPServers')]","contentVersion":"1.0.0.0"}, 
               "parameters": 
               { 
                  "ServiceName":{"value":"[parameters('ServiceName')]"},
                  "resourceLocation":{"value":"[parameters('resourceLocation')]"},
                  "administratorAccount":{"value":"[parameters('administratorAccount')]"},
                  "administratorPassword":{"value":"[parameters('administratorPassword')]"},
                  "servicePassword":{"value":"[parameters('servicePassword')]"},
                  "domainJoinUserName":{"value":"[parameters('domainJoinUserName')]"},
                  "domainJoinPassword":{"value":"[parameters('domainJoinPassword')]"},
                  "domainJoinOU":{"value":"[parameters('domainJoinOU')]"},
                  "domainName":{"value":"[parameters('domainName')]"},
                  "domainNetBiosName":{"value":"[parameters('domainNetBiosName')]"},
                  "VMSizeSP":{"value":"[parameters('VMSizeSP')]"},
                   "virtualNetworkResourceGroup":{"value":"[parameters('virtualNetworkResourceGroup')]"},
                  "virtualNetworkName":{"value":"[parameters('virtualNetworkName')]"},
                  "subnetSPName":{"value":"[parameters('subnetSPName')]"},
                  "numberSPServers":{"value":"[parameters('NumberSPServers')]"}
                  
                  }            
                  
                   
               }
               ,
            "dependsOn": [               
              
                "[concat('Microsoft.ClassicStorage/storageAccounts/', variables('StorageName'))]"
            ]  
              
          },
          */
          /*
          { 
             "apiVersion": "2015-01-01", 
             "name": "SP-Scripts-Common", 
             "type": "Microsoft.Resources/deployments", 
             "properties": { 
               "mode": "Incremental", 
               "templateLink": {"uri":"[variables('templatelink_Scripts_Common')]","contentVersion":"1.0.0.0"}, 
               "parameters": 
               { 
                  "ServiceName":{"value":"[parameters('ServiceName')]"},
                  "resourceLocation":{"value":"[parameters('resourceLocation')]"},
                  "administratorAccount":{"value":"[parameters('administratorAccount')]"},
                  "administratorPassword":{"value":"[parameters('administratorPassword')]"},
                  "servicePassword":{"value":"[parameters('servicePassword')]"},
                  "domainJoinUserName":{"value":"[parameters('domainJoinUserName')]"},
                  "domainJoinPassword":{"value":"[parameters('domainJoinPassword')]"},
                  "domainJoinOU":{"value":"[parameters('domainJoinOU')]"},
                  "domainName":{"value":"[parameters('domainName')]"},
                  "domainNetBiosName":{"value":"[parameters('domainNetBiosName')]"},
                  
                  "MediaContainerName":{"value":"[variables('MediaContainerName')]"},
                  "StorageAccountName":{"value":"[variables('StorageAccountName')]"},
                  "StorageAccountKey":{"value":"[variables('StorageAccountKey')]"},
                  
                  
                  "VMSizeSP":{"value":"[parameters('VMSizeSP')]"},
                  "VMSizeSQL":{"value":"[parameters('VMSizeSQL')]"},
                   "virtualNetworkResourceGroup":{"value":"[parameters('virtualNetworkResourceGroup')]"},
                  "virtualNetworkName":{"value":"[parameters('virtualNetworkName')]"},
                  "numberSQLServers":{"value":"[parameters('NumberSQLServers')]"},
                  "numberSPServers":{"value":"[parameters('NumberSPServers')]"}
                  
                  
                  }            
                  
                   
               }
               ,
           "dependsOn": [
               
               "['Microsoft.Resources/deployments/SQL-Servers-Template']",
               "['Microsoft.Resources/deployments/SP-Servers-Template']"
             
            ]
              
          }*/
  

    ]
}